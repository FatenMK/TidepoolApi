openapi: 3.0.0
info:
  title: Confirm API
  version: '1.0'
  description: |-
    The Tidepool API is an HTTP REST API used by Tidepool clients use to communicate with the Tidepool Platform.

    For more information, see the [Getting Started](../docs/quick-start.md) section.
  termsOfService: https://developer.tidepool.org/terms-of-use/
  contact:
    name: API Support
    url: https://support.tidepool.org/
    email: support@tidepool.org
  license:
    name: BSD-2-Clause
    url: https://github.com/tidepool-org/hydrophone/blob/master/LICENSE
  x-tidepool-service: https://github.com/tidepool-org/hydrophone

servers:
  - url: 'http://localhost:8080'
    description: local development
  - url: 'https://dev1.dev.tidepool.org'
    description: dev1
  - url: 'https://qa1.development.tidepool.org'
    description: qa1
  - url: 'https://qa2.development.tidepool.org'
    description: qa2
  - url: 'https://external.integration.tidepool.org'
    description: integration
  - url: 'https://api.tidepool.org'
    description: production

security:
  - sessionToken: []

tags:
  - name: Confirm
    description: >-
      Manage confirmations for account creation, sharing invites, etc.

paths:
  '/confirm/send/signup/{userId}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
    post:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: object
                properties: {}
        '400':
          description: ''
        '401':
          description: ''
        '403':
          description: ''
        '500':
          description: ''
      summary: Initiates account confirmation
      operationId: SendConfirmation
      tags:
        - Confirm
      security:
        - sessionToken: []
      description: Sends signup confirmation email

  '/confirm/signup/{userId}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
    get:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationList'
        '400':
          description: ''
        '401':
          description: ''
        '404':
          description: ''
        '500':
          description: ''
      summary: Fetches confirmation key
      operationId: ConfirmKey
      tags:
        - Confirm
      security:
        - sessionToken: []
      description: >-
        This endpoint is provided for completeness.
        We don't expect to need it in the actual user flow.
    put:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: object
                properties: {}
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Cancel signup
      operationId: CancelSignup
      tags:
        - Confirm
      requestBody:
        $ref: '#/components/requestBodies/ConfirmationId'
      description: Cancels the singup

  '/confirm/accept/signup/{confirmId}':
    parameters:
      - $ref: '#/components/parameters/confirmId'
    put:
      responses:
        '200':
          description: ''
        '400':
          description: Invalid confirmation key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '409':
          description: |-
            - Password is missing or invdalid
            - Birthday is missing or invalid
            - Birthday doesn't match patient's birthday
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '500':
          description: User was not found or couldn't be updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Accepts confirmation key
      operationId: ConfirmAccount
      tags:
        - Confirm
      security:
        - sessionToken: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmationAcceptance'
      description: This would be PUT by the web page at the link in the signup email.

  '/confirm/send/invite/{userId}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
    post:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Confirmation'
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '401':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '500':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Sends account invite to master account
      parameters:
        - in: query
          name: email
          schema:
            type: string
        - in: query
          name: permission
          schema:
            type: array
            items:
              type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - permissions
              properties:
                email:
                  $ref: './common/models/emailaddress.v1.yaml'
                permissions:
                  type: string
      security:
        - sessionToken: []
      tags:
        - Confirm
      operationId: SendInvite
      description: Send a invite to join my team

  '/confirm/forgot/{email}':
    parameters:
      - $ref: '#/components/parameters/confirmEmail'
    post:
      responses:
        '200':
          description: ''
        '400':
          description: Invalid email address
      summary: Sends password reset email
      operationId: SendPasswordReset
      tags:
        - Confirm
      description: >-
        If the request is correctly formed, always returns a 200, even if the
        email address was not found (this way it can't be used to validate email
        addresses).

        If the email address is found in the Tidepool system, this will:
          - Create a confirm record and a random key
          - Send an email with a link containing the key

  '/confirm/resend/signup/{email}':
    parameters:
      - $ref: '#/components/parameters/confirmEmail'
    post:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: object
                properties: {}
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '500':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Resends account confirmation email
      tags:
        - Confirm
      operationId: ResendSignup
      description: If a user didn't receive the confirmation email and logs in, they're
        directed to the confirmation-required page which can offer to resend the
        confirmation email.

  '/confirm/accept/forgot':
    put:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '400':
          description: Request body cannot be decoded or the password of the user cannot be
            updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '401':
          description: The confirmation has expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '404':
          description: No matching confirmation has been found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Accept password change
      operationId: AcceptPasswordChange
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - key
                - email
                - password
              properties:
                key:
                  type: string
                email:
                  type: string
                password:
                  type: string
      tags:
        - Confirm
      description: >-
        Accept the password change

        This endpoint will be invoked by the lost password screen with the key that was included in the URL of the lost password screen.

  '/confirm/accept/invite/{userId}/{invitedBy}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
      - name: invitedBy
        in: path
        required: true
        schema:
          $ref: './common/models/tidepooluserid.v1.yaml'
    put:
      responses:
        '200':
          description: Invite was successfully accepter
          content:
            application/json:
              schema:
                type: object
                properties: {}
        '400':
          description: Incoming data is incomplete or incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '403':
          description: There's a mismatch of the user ID's, type or status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '500':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Accept invite
      operationId: AcceptInvite
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - key
              properties:
                key:
                  type: string
      tags:
        - Confirm
      description: Accept the given invite

  '/confirm/invite/{userId}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
    get:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationList'
        '400':
          description: '- Invalid userId'
        '401':
          description: The user doesn't have root or custodian permissions.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '500':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Get sent invitations
      description: >-
        Get the still-pending invitations for a group you own or are an admin
        of.

        These are the invitations you have sent that have not been accepted. There is no way to tell if an invitation has been ignored.
      operationId: GetSentInvitations
      tags:
        - Confirm
      security:
        - sessionToken: []

  '/confirm/invitations/{userId}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
    get:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationList'
        '400':
          description: The provided userId is invalid
        '401':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Get received invitations
      operationId: GetReceivedInvitations
      tags:
        - Confirm
      security:
        - sessionToken: []
      description: Get list of received invitations for logged in user. These are
        invitations that have been sent to this user but not yet acted upon.

  '/confirm/dismiss/invite/{userId}/{invitedBy}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
      - name: invitedBy
        in: path        
        required: true
        schema:
          $ref: './common/models/tidepooluserid.v1.yaml'
    put:
      responses:
        '200':
          description: The invite was successfully dismissed
          content:
            application/json:
              schema:
                type: object
        '400':
          description: ''
        '401':
          description: ''
        '404':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '500':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Dismiss Invite
      operationId: DismissInvite
      tags:
        - Confirm
      security:
        - sessionToken: []
      requestBody:
        $ref: '#/components/requestBodies/ConfirmationLookup'
      description: Decline the invite

  '/confirm/dismiss/signup/{userId}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
    put:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: object
                properties: {}
        '400':
          description: |-
            - Invalid user id
            - Invalid request body
            - Invalid confirmation id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '404':
          description: The confirmation was not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Dismiss Signup
      tags:
        - Confirm
      description: In the event that someone uses the wrong email address, the receiver
        could explicitly dismiss a signup
      requestBody:
        $ref: '#/components/requestBodies/ConfirmationLookup'
      operationId: DismissSignup

  '/confirm/{userId}/invited/{invitedAddress}':
    parameters:
      - $ref: './common/parameters/tidepooluserid.v1.yaml'
      - name: invitedAddress
        in: path
        required: true
        schema:
          $ref: './common/models/emailaddress.v1.yaml'
    put:
      responses:
        '200':
          description: ''
          content:
            application/json:
              schema:
                type: object
                properties: {}
        '400':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '401':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
        '500':
          description: ''
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmationStatus'
      summary: Cancel Invite
      operationId: CancelInvite
      tags:
        - Confirm
      security:
        - sessionToken: []
      description: Cancel an invite the has been sent to an email address.

  '/confirm/status':
    get:
      responses:
        '200':
          description: ''
          content:
            text/plain:
              schema:
                type: string
                example: OK
      summary: Get service status
      description: >-
        Returns the status of the confirmation service
      operationId: ConfirmServiceStatus
      tags:
        - Confirm
      x-private: true

components:
  securitySchemes:
    sessionToken:
      type: apiKey
      name: X-Tidepool-Session-Token
      in: header

  parameters:
    confirmId:
      name: confirmId
      description: Confirmation ID
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/ConfirmationId'

    confirmEmail:
      name: email
      in: path
      required: true
      schema:
        $ref: './common/models/emailaddress.v1.yaml'

  requestBodies:
    ConfirmationId:
      content:
        application/json:
          schema:
            type: object
            title: Confirmation key
            required:
              - key
            properties:
              key:
                $ref: '#/components/schemas/ConfirmationId'

    ConfirmationLookup:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ConfirmationLookup'

  schemas:
    ConfirmationId:
      title: Confirmation ID that uniquely identifies each confirmation
      type: string
      format: byte

    ConfirmationType:
      title: Confirmation type
      type: string
      enum:
        - password_reset
        - careteam_invitation
        - signup_confirmation
        - no_account

    Confirmation:
      title: Confirmation
      type: object
      properties:
        key:
          $ref: '#/components/schemas/ConfirmationId'
        type:
          $ref: '#/components/schemas/ConfirmationType'
        email:
          $ref: './common/models/emailaddress.v1.yaml'
        creatorId:
          $ref: './common/models/tidepooluserid.v1.yaml'
        created:
          $ref: './common/models/datetime.v1.yaml'
        creator:
          $ref: '#/components/schemas/ConfirmationCreator'
        context:
          type: string
      required:
        - key
        - type
        - email
        - creatorId
        - created

    ConfirmationList:
      title: Confirmation list
      type: array
      items:
        $ref: '#/components/schemas/Confirmation'

    ConfirmationCreator:
      title: Creator
      type: object
      properties:
        userid:
          $ref: './common/models/tidepooluserid.v1.yaml'
        profile:
          $ref: '#/components/schemas/ConfirmationProfile'
      required:
        - userid
        - profile

    ConfirmationProfile:
      title: Creator user profile
      type: object
      required:
        - fullName
        - patient
      properties:
        fullName:
          type: string
        patient:
          $ref: '#/components/schemas/ConfirmationPatient'

    ConfirmationPatient:
      title: Patient user profile
      type: object
      properties:
        birthday:
          type: string
        diagnosisDate:
          type: string
        isOtherPerson:
          type: string
        fullName:
          type: string

    ConfirmationStatus:
      type: object
      title: Status
      description: A status object which might represent either a successfull or
        unsuccessful result.
      required:
        - code
        - reason
      properties:
        code:
          type: integer
          minimum: 100
        error:
          type: integer
        reason:
          type: string

    ConfirmationAcceptance:
      type: object
      title: Acceptance
      required:
        - password
        - birthday
      properties:
        password:
          type: string
          minLength: 8
          maxLength: 72
          pattern: ^\S{8,72}$
        birthday:
          type: string
          format: date
          pattern: ^\d{4}-\d{2}-\d{2}$

    ConfirmationLookup:
      title: Confirmation Lookup
      allOf:
        - $ref: '#/components/schemas/ConfirmationId'
